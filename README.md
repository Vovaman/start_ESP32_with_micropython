# start_ESP32_with_micropython

## Общее описание
Проект, содержащий описание всех шагов для начала работы с контроллером [ESP32](https://www.espressif.com/en/products/socs/esp32) 
на языке [Micropython](https://micropython.org/).  
Кроме описания, содержится код, который мы запустим на контроллере: мигающий диод.  
Цель -- запустить минимальный проект на контроллере, чтобы разобраться, как всё работает.  
В перспективе -- создание кода (https://github.com/Vovaman/connectorESP), управляющего подсоединенными к контроллеру устройствами и отсылающего
данные измерений в базу данных реального времени (https://github.com/Vovaman/peresvet).  
Первый практический проект -- ["антикессон"](https://github.com/Vovaman/wellCabin), будка над скважиной.  
Контроллер будет включать/выключать обогрев в будке, включать/выключать вентиляцию, а также снимать данные по давлению воды. В дальнейшем - включать/выключать насос.  
**Почему micropython?** Признаться, мне самому приятней программировать для контроллера на C, используя Arduino IDE. Но главный из вышеперечисленных проектов, [Пересвет](https://github.com/Vovaman/peresvet), реализован на Python, поэтому проще продолжать писать на питоне.

## Кому предназначено
Во-первых, мне самому, чтобы не забыть последовательность шагов.  
Во-вторых, программистам, желающим оживить и автоматизировать что-то вокруг себя.  
В-третьих, всем рукастым или не очень любителям, желающим своими руками попробовать интернет вещей [IoT](https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82_%D0%B2%D0%B5%D1%89%D0%B5%D0%B9).  
Так как среди третьих часто встречаются люди, слабо знакомые с программированием, поэтому описание несколько избыточное, но эти избыточные 
подробные описания спрятаны в спойлерах.  
Тем не менее, предполагается, что пользователи имеют базовые навыки: умеют скачивать файлы, запускать терминал, 
работать с командами в командной строке и т.д.

## Исходные данные
Имеем:  

1. Контроллер ESP32.
   Работаем с моделью [ESP32S-WROOM-32](https://aliexpress.ru/item/1005002611857804.html?item_id=1005002611857804&sku_id=12000021386518349&spm=a2g2w.productlist.0.0.28c767f2tgjXEB) (стоимость на AliExpress на момент написания текста - 389 рублей):
   ![ESP32](/img/ESP.png)  
   *Изображение с сайта http://myrobot.ru*  
   Здесь надо сказать, что существует большое разнообразие исполнений контроллера ESP32. В проекте можно использовать и другие исполнения контроллера, но в этом случае придётся скачивать другие версии прошивок.
2. Операционная система - Ubuntu 20.04.3 LTS.  
   > :note: Изначально все проекты делаются на базе Ubuntu. Windows будет добавлена только в случае запросов. 
3. Шнур USB - microUSB для подключения контроллера.  
   > :warning: **Внимание:** Часто встречаются шнуры без провода для передачи данных, только для подзарядки. Нам нужен шнур с проводом для передачи данных.

## Поехали

### 1. Node.js
Для нормальной работы расширения Pymakr, которое мы будем использовать, необходим [Node.js](https://nodejs.org/ru/).  
<details>
   <summary>Установка Node.js</summary>

   Открываем терминал и выполняем команду:  
   ```bash
   $ sudo snap install --classic node
   ```
   Проверим результат установки:
   ```bash
   $ node --version
   ```
   Команда выведет текущую версию `nodejs`.

</details>

### 2. VSCode
Устанавливаем среду разработки [VSCode](https://code.visualstudio.com/).  
> :warning: **Внимание, очень важный момент!** Если у вас VSCode уже установлена с помощью менеджера пакетов `snap`, то её необходимо удалить и поставить с помощью пакета `deb`. В версии среды, устанавливаемой с помощью `snap`, не работает необходимое нам в дальнейшем дополнение среды `Pymakr`.

<details>
   <summary>Установка VSCode</summary>
   
   1. Открываем в браузере ссылку https://code.visualstudio.com/. На открывшейся странице нажимаем кнопку `deb`:  
      ![VSpage](/img/vs0.png)         
   2. Запускаем терминал. Переходим в каталог, в который был скачан пакет (на текущий момент - `code_1.63.2-1639562499_amd64.deb`) и выполняем команду:  
      ```bash
      sudo dpkg -i code_163.2-1639562499_amd64.deb
      ```      

</details>

### 3. Pymakr
[Pymakr](https://pycom.io/products/supported-networks/pymakr/) - расширение среды VSCode для работы с `micropython`.  

<details>
   <summary>Устанавливаем Pymakr</summary>

   Для его установки нажимаем в VSCode кнопку `Расширения`(`Extentions`):  
   ![Extentions](/img/vs1.png)  
   В появившемся окне поиска расширений введём текст `Pymakr`, затем выберем найденное расширение и в окне его свойств нажмём кнопку `install`:  
   ![Pymakr](/img/vs2.png)  

</details>

В конце установки расширения откроется файл настроек и терминал внутри VSCode:  
![PymakrEnd](/img/vs3.png)  
Закроем пока и файл и терминал.

### 4. Копирование проекта
Предполагаем, что проект будет лежать в папке `~/work/projects`. 

<details>
   <summary>Клонируем</summary>

   Лучше всего, если вы заведёте свой аккаунт на сайте [github.com](https://github.com) и клонируете проект.  
   Для этого вам потребуется установить `git` - инструмент работы с хранилищами исходного кода.
   ```bash
   $ sudo apt install git
   ```
   После этого клонируем проект в вышеупомянутую папку:  
   ```bash
   $ cd ~/work/projects
   $ git clone git@github.com:Vovaman/start_ESP32_with_micropython.git
   ```     

</details>

<details>
   <summary>...или копируем проект</summary>

   Другой вариант - скачать архив с исходными кодами проекта: заходим в веб-браузере по ссылке
   `https://github.com/Vovaman/start_ESP32_with_micropython/archive/refs/heads/master.zip`.  
   Появится диалог запроса на сохранение файла. Скачайте архив и переместите его в папку `~/work/projects`.
   Разархивируйте полученный архив.

</details>

### 5. Python 3.9
По умолчанию в Ubuntu 20.04 установлен Python 3.8, нам же нужен Python 3.9.  
<details>
   <summary>Установим его</summary>

   ...выполнив последовательно в терминале команды:  
   ```bash
   $ sudo apt update
   $ sudo apt install software-properties-common
   $ sudo add-apt-repository ppa:deadsnakes/ppa
   $ sudo apt install python3.9
   ```

</details>

### 6. Инициализируем проект
Открываем терминал и заходим папку, в которой находятся исходники проекта (к примеру - 
`~/work/projects/start_ESP32_with_micropython`).

Внутри этой папки выполняем команду 
```bash
$ pipenv install
```
<details>
   <summary>Зачем?</summary>

   Pipenv - инструмент, который позволяет создать для каждого проекта, расположенного в отдельной папке, свою python-среду, со своей версией Python'а, с необходимыми модулями. Таким образом, проекты изолируются друг от друга и от операционной системы, нет конфликта версий Python'а и модулей между проектами.

</details>

В процессе инициализации будут установлены пакеты `esptool`, который мы будем использовать для прошивки контроллера и `micropy-cli` - для удобства работы с проектом.

### 7. Прошиваем контроллер

**Скачиваем прошивку**  
Заходим на страницу https://micropython.org/download/, выбираем свою модель контроллера и скачиваем нужный файл прошивки (*.bin) в папку проекта.  
Если модель контроллера совпадает с показанной на картинке в самом начале, то нужный файл (esp32-20220117-v1.18.bin
) находится в каталоге проекта. Файл скачан со страницы https://micropython.org/download/esp32/.

**Определяем порт**
<details>
   <summary>Чаще всего порт - ttyUSB0</summary>

   Определим создаваемый при подключении контроллера порт. Для этого:  
   Зайдём в каталог `/dev` и выведем список устройств:
   ```bash
   $ cd /dev
   $ ls
   ``` 
   Соединим шнуром контроллер с USB-портом компьютера и опять посмотрим список устройств в том же каталоге `/dev`:
   ```bash
   $ ls
   ```
   Посмотрим, какая строка добавилась в списке по сравнению с первым случаем, это и будет нужное нам имя порта. Скорее всего, это будет `ttyUSB0`.

</details>

**Даём права на запись в порт**
<details>
   <summary>sudo adduser <user_name> dialout</summary>

   Чтобы иметь возможность прошить контроллер, пользователь, под которым мы работаем, должен иметь права на запись в определённый нами USB-COM порт.  
   Для этого выполним команду (вместо `<user_name>` подставьте имя вашего аккаунта в операционной системе):
   ```bash
   $ sudo adduser <user_name> dialout
   ```

</details>

**Перепрошиваем контроллер**
<details>
   <summary>Открываем проект в VSCode</summary>

   Запускаем VSCode, командой меню `Файл --> Открыть папку...` открываем папку с проектом: `~/work/projects/ESP32`.  
</details>

<details>
   <summary>В VSCode открываем терминал</summary>

   В VSCode выполняем команду меню `Терминал --> Создать терминал`.  
   Внизу откроется окно терминала, при этом автоматически инициализируется среда проекта.  
   Об инициализации среды будет говорить то, что перед приглашением командной строки будет имя проекта  скобках 
   (в моем случае - start_ESP32_with_micropython):  
   ![Env](/img/term01.png)   

</details>

Стираем прошивку в контроллере:
```bash
$ esptool.py --chip esp32 --port /dev/ttyUSB0 erase_flash
```
И запишем новую, с micropython'ом (подставим нужное имя файла):
```bash
$ esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash -z 0x1000 esp32-20220117-v1.18.bin
```
> :note: Если ваш чип - не указанный в проекте, то скопируйте команды стирания прошивки и её записи со страницы, с которой скачивали нужную вам прошивку!

Проверим результат, для чего будем использовать команды Pymakr в строке состояния VSCode:  
1. Откроем файл `pymakr.conf` и исправим поле `address`, вписав туда правильное имя порта.
2. Кликнем на надписи `Pymakr Console`:  
   ![Pymakr](/img/pymakr.png)
3. Откроется окно терминала следующего вида:
   ![Pymakr2](/img/pymakr02.png)  
   Мы находимся в консоли, предоставляемой Python'ом контроллера.  
   Введём в консоли следующий текст: 
   ```python
   from machine import Pin
   p2 = Pin(2, Pin.OUT)
   p2.on()
   ```
   В результате на контроллере загорится синий диод (пример действителен только для контроллеров со встроенным диодом).

### 8. Заливаем проект
Перед заливкой необходимо соединиться с устройством, либо открыв консоль Pymakr, либо выполнив команду `Pymakr --> Connect`.  
В окне списка файлов кликнем правой кнопкой мыши и в появившемся меню выберем команду `Pymakr --> Upload project`, либо в строке состояния VSCode
из списка команд Pymakr (2):  
![Pymakr2](/img/pymakr02.png)  
выберем ту же команду.  
<details>
   <summary>Обратите внимание, что:</summary>

   в настройках проекта в файле `pymakr.conf` (ключ `sync_folder`) указано, 
   что исходные коды загружаемого в контроллер проекта находятся в каталоге `src`.  
   У проекта два главных файла:  
   1. boot.py, выполняемый при загрузке контроллера (аналог функции `void setup()`, если бы мы писали код на C)
   2. main.py, запускаемый после `boot.py`.  
   Файл `boot.py` может отсутствовать. 

</details>
После заливки проекта на контроллере будет мигать синий диод, посылая сигнал SOS, а в открывшемся терминале периодически будет появляться строка "SOS!".  
Проект будет работать и после перезагрузки контроллера.

> :note: При работающем на контроллере проекте, во время коннекта к контроллеру необходимо нажать Ctrl+C, чтобы прекратить выполнение проекта и попасть
  в консоль питона на контроллере.

## Заключение
Мы подготовили среду и залили свой первый проект на Micropython на контроллер ESP32.  

> :note: В качестве дополнения установите себе инструмент `picocom`:
  ```bash
  sudo apt install picocom
  ```
  Это удобный инструмент, предоставляющий доступ к Python-консоли контроллера:  
  ```bash
  $ picocom /dev/ttyUSB0 -b115200
  ```