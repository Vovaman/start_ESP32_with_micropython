[Eng](README.md)
# start_ESP32_with_micropython

## Общее описание
Проект, содержащий описание всех шагов для начала работы с контроллером [ESP32](https://www.espressif.com/en/products/socs/esp32)
на языке [Micropython](https://micropython.org/).
Кроме описания, содержится код, который мы запустим на контроллере: мигающий диод.
Цель -- запустить минимальный проект на контроллере, чтобы разобраться, как всё работает.
В перспективе -- создание кода (https://github.com/Vovaman/connectorESP), управляющего подсоединенными к контроллеру устройствами и отсылающего
данные измерений в базу данных реального времени (https://github.com/Vovaman/peresvet).
Первый практический проект -- ["антикессон"](https://github.com/Vovaman/wellCabin), будка над скважиной.
Контроллер будет включать/выключать обогрев в будке, включать/выключать вентиляцию, а также снимать данные по давлению воды. В дальнейшем - включать/выключать насос.
**Почему micropython?** Признаться, мне самому приятней программировать для контроллера на C, используя Arduino IDE. Но главный из вышеперечисленных проектов, [Пересвет](https://github.com/Vovaman/peresvet), реализован на Python, поэтому проще продолжать писать на питоне.

## Кому предназначено
Во-первых, мне самому, чтобы не забыть последовательность шагов.
Во-вторых, программистам, желающим оживить и автоматизировать что-то вокруг себя.
В-третьих, всем рукастым или не очень любителям, желающим своими руками попробовать интернет вещей [IoT](https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82_%D0%B2%D0%B5%D1%89%D0%B5%D0%B9).
Так как среди третьих часто встречаются люди, слабо знакомые с программированием, поэтому описание несколько избыточное, но эти избыточные
подробные описания спрятаны в спойлерах.
Тем не менее, предполагается, что пользователи имеют базовые навыки: умеют скачивать файлы, запускать терминал,
работать с командами в командной строке и т.д.

## Исходные данные
Имеем:

1. Контроллер ESP32.
   Работаем с моделью [ESP32S-WROOM-32](https://aliexpress.ru/item/1005002611857804.html?item_id=1005002611857804&sku_id=12000021386518349&spm=a2g2w.productlist.0.0.28c767f2tgjXEB) (стоимость на AliExpress на момент написания текста - 389 рублей):
   ![ESP32](/img/ESP.png)
   *Изображение с сайта http://developer.alexanderklimov.ru/arduino/esp32/*
   Здесь надо сказать, что существует большое разнообразие исполнений контроллера ESP32. В проекте можно использовать и другие исполнения контроллера, но в этом случае придётся скачивать другие версии прошивок.
2. Операционная система - Ubuntu 22.04 LTS.
   > :warning: Изначально все проекты делаются на базе Ubuntu. Windows будет добавлена только в случае запросов.
3. Шнур USB - microUSB для подключения контроллера.
   > :warning: **Внимание:** Часто встречаются шнуры без провода для передачи данных, только для подзарядки. Нам нужен шнур с проводом для передачи данных.

## Поехали

### 1. Node.js
Для нормальной работы расширения Pymakr, которое мы будем использовать, необходим [Node.js](https://nodejs.org/ru/).
<details>
   <summary>Установка Node.js</summary>

   Открываем терминал и выполняем команду:
   ```bash
   $ sudo snap install --classic node
   ```
   Проверим результат установки:
   ```bash
   $ node --version
   ```
   Команда выведет текущую версию `nodejs`.

</details>

### 2. VSCode
Устанавливаем среду разработки [VSCode](https://code.visualstudio.com/).
> :warning: **Внимание, очень важный момент!** Если у вас VSCode уже установлена с помощью менеджера пакетов `snap`,
> то её необходимо удалить и поставить с помощью пакета `deb`.
> В версии среды, устанавливаемой с помощью `snap`, не работает необходимое нам в дальнейшем дополнение среды `Pymakr`.

<details>
   <summary>Установка VSCode</summary>

   1. Открываем в браузере ссылку https://code.visualstudio.com/. На открывшейся странице нажимаем кнопку `deb`:
      ![VSpage](/img/vs0.png)
   2. Запускаем терминал. Переходим в каталог, в который был скачан пакет (на текущий момент - `code_1.63.2-1639562499_amd64.deb`) и выполняем команду:
      ```bash
      sudo dpkg -i code_163.2-1639562499_amd64.deb
      ```

</details>

### 3. Дополнения к VSCode
Теперь установим необходимые дополнения к VSCode: Python, Pylance, Pymakr

![Py...](/img/addins_python_pylance.png)

![Pymakr](/img/addins_pymakr.png)

> :warning: **Внимание:** Перезагрузите компьютер после установки **Pymakr**

### 4. Установка pipenv и pyenv
Перейдём в домашнюю папку.
```bash
cd ~
```

pipenv - менеджер зависимостей для python, позволяющий управлять виртуальными
окружениями:
```bash
pip3 install pipenv --user
```
pyenv - менеджер версий интерпретатора python, используется pipenv для установки
версий python:
```bash
curl https://pyenv.run | bash
```
После установки добавьте в файл ~/.bashrc:
```bash
export PATH="$HOME/.pyenv/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"
export PIPENV_VENV_IN_PROJECT=1
```
И выполните команду:
```bash
source .bashrc
```

### 5. Копирование проекта
Предполагаем, что проект будет лежать в папке `~/work/projects`.

<details>
   <summary>Клонируем</summary>

   Лучше всего, если вы заведёте свой аккаунт на сайте [github.com](https://github.com) и клонируете проект.
   Для этого вам потребуется установить `git` - инструмент работы с хранилищами исходного кода.
   ```bash
   $ sudo apt install git
   ```
   После этого клонируем проект в вышеупомянутую папку:
   ```bash
   $ cd ~/work/projects
   $ git clone git@github.com:Vovaman/start_ESP32_with_micropython.git
   ```

</details>

<details>
   <summary>...или копируем проект</summary>

   Другой вариант - скачать архив с исходными кодами проекта: заходим в веб-браузере по ссылке
   `https://github.com/Vovaman/start_ESP32_with_micropython/archive/refs/heads/master.zip`.
   Появится диалог запроса на сохранение файла. Скачайте архив и переместите его в папку `~/work/projects`.
   Разархивируйте полученный архив и переименуйте получившуюся папку с исходниками в `start_ESP32_with_micropython`.

</details>

### 6. Инициализируем проект
Открываем терминал и заходим в папку, в которой находятся исходники проекта: `~/work/projects/start_ESP32_with_micropython`.

Внутри этой папки выполняем команду
```bash
$ pipenv install
```
<details>
   <summary>Зачем?</summary>

   Pipenv - инструмент, который позволяет создать для каждого проекта, расположенного в отдельной папке, свою python-среду, со своей версией Python'а, с необходимыми модулями. Таким образом, проекты изолируются друг от друга и от операционной системы, нет конфликта версий Python'а и модулей между проектами.

</details>

В процессе инициализации будут установлены пакеты:
- `esptool`, который мы будем использовать для прошивки контроллера и
- `micropy-cli` - для удобства работы с проектом.

### 7. Прошиваем контроллер

**Скачиваем прошивку**
Заходим на страницу https://micropython.org/download/, выбираем свою модель контроллера и скачиваем нужный файл прошивки (*.bin) в папку проекта.
Если модель контроллера совпадает с показанной на картинке в самом начале, то нужный файл (esp32-20220117-v1.18.bin)
находится в каталоге проекта. Файл скачан со страницы https://micropython.org/download/esp32/.

**Определяем порт**
<details>
   <summary>Чаще всего порт - ttyUSB0</summary>

   Определим создаваемый при подключении контроллера порт. Для этого:
   Зайдём в каталог `/dev` и выведем список устройств:
   ```bash
   $ cd /dev
   $ ls
   ```
   Соединим шнуром контроллер с USB-портом компьютера и опять посмотрим список устройств в том же каталоге `/dev`:
   ```bash
   $ ls
   ```
   Посмотрим, какая строка добавилась в списке по сравнению с первым случаем, это и будет нужное нам имя порта. Скорее всего, это будет `ttyUSB0`.

</details>

**Даём права на запись в порт**
<details>
   <summary>sudo adduser user_name dialout</summary>

   Чтобы иметь возможность прошить контроллер, пользователь, под которым мы работаем, должен иметь права на запись в определённый нами USB-COM порт.
   Для этого выполним команды:
   ```bash
   # добавим себя в нужную группу
   $ sudo adduser $USER dialout
   # обновим изменение прав
   $ su - $USER
   ```

</details>

**Перепрошиваем контроллер**
<details>
   <summary>Открываем проект в VSCode</summary>

   Запускаем VSCode, командой меню `Файл --> Открыть папку...` открываем папку с проектом: `~/work/projects/start_ESP32_with_micropython`.
</details>

<details>
   <summary>В VSCode открываем терминал...</summary>

   В VSCode выполняем команду меню `Терминал --> Создать терминал`.
   Внизу откроется окно терминала, при этом автоматически инициализируется среда проекта.
   Об инициализации среды будет говорить то, что перед приглашением командной строки будет имя проекта скобках
   (start_ESP32_with_micropython):
   ![Env](/img/term01.png)

</details>

...и, убедившись, что среда проекта активирована, выполняем команду, стирающую прошивку в контроллере:
```bash
$ esptool.py --chip esp32 --port /dev/ttyUSB0 erase_flash
```
И запишем новую, с micropython'ом:
```bash
$ esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash -z 0x1000 esp32-20220117-v1.18.bin
```
> :warning: Если ваш чип - не указанный в проекте, то скопируйте команды стирания прошивки и её записи со страницы, с которой скачивали нужную вам прошивку!
> Также подставьте нужное имя порта и имя файла прошивки!

Проверим результат, для чего будем использовать команды Pymakr.

Проверимм, что Pymakr распознал наше устройство:
![Pymakr](/img/pymakr01.png)
Нажмём на значок "Pymakr" и мы должны увидеть в списке устройств свой порт.
В противном случае нажмите на иконку многоточия справа от слова "Devices"
и выберите команду "New device --> Serial..." и добавьте своё устройство.

Теперь подведём указатель мыши правее от названия нашего порта и выберем команду
"Connect device" (иконка молнии):
![Connect](/img/pymakr02.png)
Затем переместимся левее и нажмём иконку "Create terminal".
Появится окно терминала с запущенной на контроллере консолью micropython'а:
![Terminal](/img/pymakr03.png)

Введём в консоли следующий текст:
```python
>>> from machine import Pin
>>> p2 = Pin(2, Pin.OUT)
>>> p2.on()
```
В результате на контроллере загорится синий диод (пример действителен только для контроллеров со встроенным диодом).

### 8. Заливаем проект
Перед заливкой необходимо соединиться с устройством (что мы, впрочем, уже сделали на предыдущем шаге).
В окне списка файлов проекта кликнем правой кнопкой мыши на файле "main.py"
и выберем команду "Pymakr --> Upload to device...":
![Upload](/img/pymakr04.png)

...затем выполним команду "Hard reset device":
![Upload](/img/pymakr06.png)

После перезагрузки контроллера на нём будет мигать синий диод,
посылая сигнал SOS.

Для того, чтобы увидеть вывод скрипта в терминале, необходимо:
1. Остановить работу скрипта на контроллере командой "Stop script";
2. Открыть терминал на контроллере;
3. Выбрав файл "main.py", нажать правую кнопку мыши и выбрать команду
   "Pymakr --> Run file on device".

> :warning: При работающем на контроллере проекте, после коннекта к контроллеру
  необходимо выполнить команду "Stop script", чтобы прекратить выполнение проекта и попасть
  в консоль питона на контроллере:
  ![StopScript](/img/pymakr05.png)

## Заключение
Мы подготовили среду и залили свой первый проект на Micropython на контроллер ESP32.

> :warning: В качестве дополнения установите себе инструмент `picocom`:
>  ```bash
>  sudo apt install picocom
>  ```
>  Это удобный инструмент, предоставляющий доступ к Python-консоли контроллера:
>  ```bash
>  $ picocom /dev/ttyUSB0 -b115200
>  ```
